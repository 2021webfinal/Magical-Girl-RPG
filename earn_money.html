<head>
    <title>15money</title>
    <meta charset="utf-8" />
    <style type="text/css">
        caption, td {
            font-weight: bold;
            font-family: helvetica, arial, sans-serif;
        }
        caption {
            font-size: 3em;
            color: gray;
        }
        td {
            font-size: 4em;
            color: blue;
            border: 2px solid gray;
            padding: 5px;
        }
        div {
            font-size: 2em;
            color: red;
        }
        button {
            width: 80px;
            height: 50px;
		}
		img {
			position:absolute;
			top:0;
			left:0;
			width: 555px;
		}
    </style>
    <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
    <script type="text/javascript">
    </script>
</head>
<body>
	<audio id="getaudio">
            <source src="offlimits.mp3" type="audio/mpeg">
    </audio>
	<audio id="winaudio">
            <source src="applause.mp3" type="audio/mpeg">
    </audio>
    <table id="board" border="1">
        <caption>15-money</caption>
        <tbody>
            <tr>
                <td onclick="doClick( 0, 0 )" id="cell00"></td>
                <td onclick="doClick( 0, 1 )" id="cell01"></td>
                <td onclick="doClick( 0, 2 )" id="cell02"></td>
                <td onclick="doClick( 0, 3 )" id="cell03"></td>
            </tr>
            <tr>
                <td onclick="doClick( 1, 0 )" id="cell10"></td>
                <td onclick="doClick( 1, 1 )" id="cell11"></td>
                <td onclick="doClick( 1, 2 )" id="cell12"></td>
                <td onclick="doClick( 1, 3 )" id="cell13"></td>
            </tr>
            <tr>
                <td onclick="doClick( 2, 0 )" id="cell20"></td>
                <td onclick="doClick( 2, 1 )" id="cell21"></td>
                <td onclick="doClick( 2, 2 )" id="cell22"></td>
                <td onclick="doClick( 2, 3 )" id="cell23"></td>
            </tr>
            <tr>
                <td onclick="doClick( 3, 0 )" id="cell30"></td>
                <td onclick="doClick( 3, 1 )" id="cell31"></td>
                <td onclick="doClick( 3, 2 )" id="cell32"></td>
                <td onclick="doClick( 3, 3 )" id="cell33"></td>
            </tr>
        </tbody>
    </table>
    <p>
        <button ><a href="start_page.html">回首頁</a></button>
        <button onclick="gotoLastStep()" id="laststepBtn">作弊</button>
        <button onclick="importData()" id="importBtn">重玩</button>
        <button onclick="switchBGM()" id="bgmBtn">開/關BGM</button>
    </p>
    <div id="msg"></div>
	<img id="ldin">
    <script>
		var mg=document.getElementById("ldin");
		var cheat=0;
		console.log(mg);
        var zx=0,zy=0,sd=document.getElementById("getaudio"),wd=document.getElementById("winaudio");
		sd.muted=true;
		sd.loop=true;
		var bonus;
		function importData(){
			cheat=0;
			$.getJSON("https://soselab2020.github.io/puzzle/puzzle-1.json",function(result){
				bonus="";
				$.each(result, function(i, field){
					bonus+=field;
				});
				$("img").css("display","inline");
				console.log(bonus);
				mg.src="loading.gif";
				setTimeout(function(){
					$("img").css("display","none");
				},1000);
				bstart();
			});
		}
		function bstart(){
			var rand=Math.floor(Math.random()*35)*46;
			var it=0;
			for(var i=0;i<4;++i)
                for(var j=0;j<4;++j){
					var tmp="";
					while(bonus[rand+it]!=','){
						tmp+=bonus[rand+it];
						++it;
					}
					++it;
					document.getElementById("cell"+i+j).innerHTML=tmp;
				}
		}
        function judge(x,y){
            for(var i=0;i<4;++i)
                for(var j=0;j<4;++j)
                    if(document.getElementById("cell"+i+j).innerHTML=="")
                        zx=i,zy=j;
            if(zx==x&&zy==y)
                document.getElementById("msg").innerHTML="我看倒有點像稿紙";
            else if(Math.abs(zx-x)<=1&&Math.abs(zy-y)<=1&&!(Math.abs(zy-y)==1&&Math.abs(zx-x)==1))
                document.getElementById("msg").innerHTML="這一格好像能點";
            else
                document.getElementById("msg").innerHTML="真像一塊塊綠豆糕";
        }
        $("td").hover(function() {
            var id=$(this).prop("id");
            var i=id[4],j=id[5];
            Number(i);
            Number(j);
            judge(i,j);
        })
        function gotoLastStep(){
            count=1;
			cheat=1;
            for(var i=0;i<4;++i){
                for(var j=0;j<4;++j){
                    if(count<10)
                        document.getElementById("cell"+i+j).innerHTML='0'+count;
                    else
                        document.getElementById("cell"+i+j).innerHTML=count;
                    ++count;
                }
            }
            var rd=Math.floor(Math.random()*2);
            if(rd==0){
                document.getElementById("cell33").innerHTML="12";
                document.getElementById("cell23").innerHTML="";
            }
            else{
                document.getElementById("cell33").innerHTML="15";
                document.getElementById("cell32").innerHTML="";
            }
            judge(0,0);
        }
        function finaljudge(){
            var win=1,count=1;
            for(var i=0;i<4;++i){
                for(var j=0;j<4;++j){
                    if(document.getElementById("cell"+i+j).innerHTML==""){
                        ++count;
                        continue;
                    }
                    else{
                        if(Number(document.getElementById("cell"+i+j).innerHTML)!=count)
                            win=0;
                        ++count;
                    }
                }
            }
			if(win==1&&cheat==1){
				wd.play();
				alert("喔~章魚哥，你作弊~");
				importData();
			}
            else if(win==1){
				wd.play();
                alert("挖你好棒喔，給你錢");
				var money=localStorage.getItem("$");
				localStorage.setItem("$",parseInt(money)+100);
				window.location.href='start_page.html';
			}
        }
		function switchBGM(){
			sd.play();
			if(sd.muted==true)
				sd.muted=false;
			else
				sd.muted=true;
		}
        function doClick(x,y){
            if(document.getElementById("msg").innerHTML=="這一格好像能點"){
                var tmpx=document.getElementById("cell"+x+y).innerHTML;
                document.getElementById("cell"+x+y).innerHTML="";
                document.getElementById("cell"+zx+zy).innerHTML=tmpx;
                judge(x,y);
                finaljudge();
            }
        }
		window.addEventListener("load",importData,false);
    </script>
</body>

</html>