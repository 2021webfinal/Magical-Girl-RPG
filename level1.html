<html>
	<head>
		<title>level_1</title>
		<style>
			.ml3 {
			  font-weight: 90;
			  font-size: 2em;
			  color: blue;
			}
			.ctbox {
				border: solid 5px green;
				background-color: lightgreen;
				height: 250px;
				width: 500px;
				overflow:scroll;
			　	display:inline;
			}
		</style>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/2.0.2/anime.min.js"></script>
	</head>
	<body>
		<div>progress
			<div id="progress">1</div>/10
		</div>
		<div><input id="go" type="button" value="前進"></div>
		<div><input id="back" type="button" value="撤退"></div>
		<div><input id="tool" type="button" value="道具"></div>
		<div class="ctbox">
			<p id="chatbox" class="ml3">進入關卡1</p>
		</div>
		<div id="battle_display" class="fight_screen">
			<input id="attack" type="button" value="攻擊">
			<input id="skill" type="button" value="技能">
			<input id="run_out" type="button" value="逃跑">
			<div id="p1_state">
			</div>
			<div id="monster">
			</div>
		</div>
		<script>
			var battle=0;
			var bd = document.getElementById("battle_display");
			var p1s = document.getElementById("p1_state");
			var mons = document.getElementById("monster");
			var talk = document.getElementById("chatbox");
			var back = document.getElementById("back");
			var player_name=localStorage.getItem("start_adventure");
			var state=JSON.parse(localStorage.getItem(player_name));
			var p=1,quitalt=0,money;
			var step,test_HP;
			function amt(){
				var textWrapper = document.querySelector('.ml3');
				textWrapper.innerHTML = textWrapper.textContent.replace(/\S/g, "<span class='letter'>$&</span>");
				anime.timeline({loop: false})
				.add({
					targets: '.ml3 .letter',
					opacity: [0,1],
					easing: "easeInOutQuad",
					duration: 10,
					delay: (el, i) => 150 * (i+1)
				});
			}
			function fight(){
				bd.style.visibility= "visible";
				console.log(state);
				step=1;
				test_HP=100;
				state_load();
			}
			function go_atk(){
				++step;
				talk.innerHTML = "第"+step+"回合,你打了test一下造成了"+state.atk+"點傷害!";
				amt();
				test_HP-=state.atk;
				state_load();
			}
			function go_skill(){
				alert("這個目前啥也不會");
			}
			function runaway(){
				test_HP=-1;
				talk.innerHTML = "成功逃跑了";
				amt();
				state_load();
			}
			function state_load(){
				p1s.innerHTML= "魔法少女 "+player_name+"還剩下"+state.MAXHP+"/"+state.HP+"的生命值";
				mons.innerHTML="測試怪還有"+test_HP+"的生命值";
				if(state.HP<=0||test_HP<=0){
					battle=0;
					bd.style.visibility= "hidden";
					talk.innerHTML+="test被你打爆了!";
					amt();
				}
			}
			function boss_fight(){
				talk.innerHTML = "期末考!!!";
				amt();
			}
			function random_event(){
				var r=Math.floor(Math.random()*3);
				if(r==0){
					talk.innerHTML = "遭遇隨堂考!";
					battle=1;
					fight();
				}	
				else if(r==1){
					talk.innerHTML = "撿到錢~";
					money+=10;
				}
				else{
					talk.innerHTML = "啥都沒看到";
				}
				amt();
			}
			function go_step(){
				if(battle==1){
					alert("你還在打架ㄟ想跑去哪?");
				}
				else{
					++p;
					document.getElementById("progress").innerHTML=p;
					if(p==11){
						document.getElementById("progress").innerHTML="end";
						talk.innerHTML = "恭喜你通過了第一學期!";
						localStorage.setItem("$",money);
						localStorage.setItem("&Level_1",1);
						amt();
						back.value="光榮撤退";
						quitalt=1;
					}
					else if(p==10){
						boss_fight();
						quitalt=0;
					}
					else if(p<10){
						random_event();
						quitalt=0;
					}
					else{
						talk.innerHTML = "這前面啥都沒有了";
						amt();
						quitalt=1;
					}
				}
			}
			function go_home(){
				talk.innerHTML = "你確定要離開ㄇ?這樣你一毛都拿不到喔(確定請再次點擊撤退紐)";
				amt();
				++quitalt;
				if(quitalt==2){
					document.location.href="adventure.html";
				}
			}
			function use_t(){
				alert("你翻了一下包包，然後發現你啥都沒帶");
				quitalt=0;
			}
			function start(){
				document.getElementById("attack").addEventListener("click",go_atk,false);
				document.getElementById("skill").addEventListener("click",go_skill,false);
				document.getElementById("run_out").addEventListener("click",runaway,false);
				bd.style.visibility= "hidden";
				money=localStorage.getItem("$");
				money=parseInt(money);
				document.getElementById("go").addEventListener("click",go_step,false);
				document.getElementById("back").addEventListener("click",go_home,false);
				document.getElementById("tool").addEventListener("click",use_t,false);
				amt();
			}
			window.addEventListener("load",start,false);
		</script>
	</body>
</html>
