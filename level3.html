<html>
	<head>
		<title>level_3</title>
		<style>
			.ml3 {
			  font-weight: 90;
			  font-size: 2em;
			  color: blue;
			}
			.ctbox {
				border: solid 5px green;
				background-color: lightgreen;
				height: 250px;
				width: 500px;
				overflow:scroll;
			}
			space{
				color: lightgreen;
			}
			.aboriginal{
				color: red;
				font-size: 1.35em;
			}
			.wooden{
				width:200px;height:200px;
			}
		</style>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/2.0.2/anime.min.js"></script>
	</head>
	<body>
		<div>progress
			<div id="progress">1</div>/20
		</div>
		<div><input id="go" type="button" value="前進"></div>
		<div><input id="back" type="button" value="撤退"></div>
		<div><input id="tool" type="button" value="道具"></div>
		<div class="ctbox">
			<p id="chatbox" class="ml3">進入關卡3</p>
		</div>
		<div id="open_or_skip" class="choose">
			<input id="open" type="button" value="打開看看"></input>
			<input id="skip" type="button" value="還是算了..."></input>
		</div>
		<div id="battle_display" class="fight_screen">
			<input id="attack" type="button" value="攻擊">
			<input id="skill" type="button" value="技能">
			<input id="run_out" type="button" value="逃跑">
			<input id="take_look" type="button" value="偵查">
			<div id="p1_state">
			</div>
			<div id="monster">
			</div>
		</div>
		<div id="kill_or_forgive" class="choose">
			<input id="kill" type="button" value="剁!"></input>
			<input id="forgive" type="button" value="放他走"></input>
		</div>
		<script>
			var gogo=0;
			var boss_f=0;
			var combo=1;
			var mb=0;
			var low_san=0;
			var battle=0;
			var forgave = document.getElementById("forgive");
			var oos = document.getElementById("open_or_skip");
			var kof = document.getElementById("kill_or_forgive");
			var bd = document.getElementById("battle_display");
			var p1s = document.getElementById("p1_state");
			var mons = document.getElementById("monster");
			var talk = document.getElementById("chatbox");
			var back = document.getElementById("back");
			var player_name=localStorage.getItem("start_adventure");
			var state=JSON.parse(localStorage.getItem(player_name));
			var backpack=JSON.parse(localStorage.getItem("&backpack"));
			var p=1,quitalt=0,money;
			var step;
			var loser;
			var HP,atk,def,spd,lv,exp,name;
			var enemy={
				HP,atk,def,spd,lv,exp,name
			};
			function amt(){
				var textWrapper = document.querySelector('.ml3');
				textWrapper.innerHTML = textWrapper.textContent.replace(/\S/g, "<span class='letter'>$&</span>");
				anime.timeline({loop: false})
				.add({
					targets: '.ml3 .letter',
					opacity: [0,1],
					duration: 10,
					delay: (el, i) => 150 * (i+1)
				});
			}
			//以下戰鬥
			function fight(){
				bd.style.visibility= "visible";
				console.log(state);
				if(boss_f==1){
					enemy.name="瑞斯";
					enemy.HP=345;
					enemy.atk=30;
					enemy.def=30;
					enemy.spd=6;
					enemy.lv=5;
					enemy.exp=50;
				}
				else{
					var rmm=Math.random();
					if(rmm>0.5){
						enemy.name="鼠鼠";
						enemy.HP=133;
						enemy.atk=50;
						enemy.def=22;
						enemy.spd=7;
						enemy.lv=3;
						enemy.exp=5;
					}
					else{
						enemy.name="凱多";
						enemy.HP=244;
						enemy.atk=17;
						enemy.def=35;
						enemy.spd=4;
						enemy.lv=4;
						enemy.exp=8;
					}
				}
				step=0;
				combo=1;
				loser=0;
				state_load();
			}
			function go_atk(){
				if(mb==1)stun();
				else{
					step++;
					var damage=Math.floor(Math.random()*(state.atk+100*(1+(state.lv-enemy.lv)*0.1)/(enemy.def+50)));
					talk.innerHTML = "第"+step+"回合<br>"+"你對"+enemy.name+"攻擊<br>造成了"+damage+"點傷害!";
					var dbhit=(state.spd-enemy.spd)/10;
					var dbcheck=Math.random();
					if(dbhit>dbcheck){
						talk.innerHTML += "<br>你的速度太快了，對方根本來不及反應因此你多補了一刀!造成額外"+damage+"點傷害!";
						enemy.HP-=damage;
					}
					enemy.HP-=damage;
					enemy_turn();
					sanjudge();
					state_load();
				}
			}
			function enemy_turn(){
				var atk_type=Math.random();
				if(atk_type>0.5){
					var hurt=Math.floor(Math.random()*(enemy.atk-state.def/10)*(1+(enemy.lv-state.lv)*0.1));
					talk.innerHTML+="<br>"+enemy.name+"攻擊<br>你受到了"+hurt+"點傷害!";
					state.HP-=hurt;
					if(boss_f==1){
						var boss_s=Math.random()*0.35;
						var boss_check=Math.random();
						if(boss_s>boss_check){
							talk.innerHTML = "<br>瑞斯AAAAAA，你暈了!";
							mb=1;
						}
					}
					diejudge();
				}
				else{
					var spirit=Math.floor(enemy.atk/4*(1+(enemy.lv-state.lv)*0.1));
					talk.innerHTML+="<br>"+enemy.name+"對你使用瘋狗吶喊<br>你受到了"+spirit+"點精神傷害!";
					state.SP-=spirit;
					sanjudge();
				}
			}
			function go_skill(){
				if(state.gender==1||state.gender==0)alert("這個人啥也不會");
				else if(mb==1){
					stun();
				}
				else if(state.gender==2){
					mb=1;
					step++;
					var damage=Math.floor(Math.random()*(state.atk+100*(1+(state.lv-enemy.lv)*0.1)/(enemy.def+50))*1.35);
					talk.innerHTML = "第"+step+"回合<br>"+"你對test使用了<span class='aboriginal'>原著民爆擊的啦</span><br>造成了"+damage+"點傷害!";
					enemy.HP-=damage;
				}
				else if(state.gender==3){
					step++;
					var damage=Math.floor(Math.random()*(state.atk+100*(1+(state.lv-enemy.lv)*0.1)/(enemy.def+50)));
					var heal=Math.floor(damage/10);
					talk.innerHTML = "第"+step+"回合<br>"+"你對test用<span class='aboriginal'>吸血</span><br>造成了"+damage+"點傷害!<br>你回復了"+heal+"點生命值";
					state.HP=Math.min(state.MAXHP,state.HP+heal);
					state.SP-=10;
					enemy.HP-=damage;
				}
				else if(state.gender==4){
					step++;
					var heal=Math.floor(state.MAXHP/2);
					talk.innerHTML = "第"+step+"回合<br>"+"你使用了<span class='aboriginal'>超量治癒</span><br>你回復了"+heal+"點生命值";
					state.HP+=heal;
					state.SP-=15;
				}
				else if(state.gender==5){
					step++;
					var damage=Math.floor(Math.random()*(state.atk+100*(1+(state.lv-enemy.lv)*0.1)/(enemy.def+50))*combo);
					talk.innerHTML = "第"+step+"回合<br>"+"你對test用<span class='aboriginal'>連擊星</span><br>造成了"+damage+"點傷害!";
					combo+=0.1;
					state.SP-=5;
					enemy.HP-=damage;
				}
				else if(state.gender==6){
					step++;
					var healSP=Math.floor(state.MAXSP/3);
					talk.innerHTML = "第"+step+"回合<br>"+"你使用了<span class='aboriginal'>氣定神閒</span><br>你回復了"+healSP+"點精神!";
					state.SP=Math.min(state.SP+healSP,state.MAXSP);
				}
				else if(state.gender==7){
					step++;
					var damage=Math.floor(Math.random()*(state.atk+100*(1+(state.lv-enemy.lv)*0.1)/(enemy.def+50))*combo);
					damage = Math.floor(damage*(1+0.01*(state.MAXHP-state.HP)));
					talk.innerHTML = "第"+step+"回合<br>"+"你對test用<span class='aboriginal'>復仇反擊</span><br>造成了"+damage+"點傷害!";
					state.SP-=8;
					enemy.HP-=damage;
				}
				else if(state.gender==8){
					step++;
					var damage=Math.floor(Math.random()*(state.atk+100*(1+(state.lv-enemy.lv)*0.1)/(enemy.def+50))*0.85);
					talk.innerHTML = "第"+step+"回合<br>"+"你對test用<span class='aboriginal'>客+1及</span><br>造成了"+damage+"點傷害!<br>你偷了三塊錢";
					money+=3;
					enemy.HP-=damage;
					state.SP-=1;
				}
				else if(state.gender==9){
					step++;
					talk.innerHTML = "第"+step+"回合<br>"+"你對test用<span class='aboriginal'>看破</span><br>你無視了他的防禦";
					state.SP-=10;
					enemy.def=0;
				}
				if(state.gender!=1&&state.gender!=0&&mb==0){
					enemy_turn();
					sanjudge();
					state_load();
				}
			}
			function stun(){
				mb=0;
				step++;
				talk.innerHTML = "第"+step+"回合<br>"+"你暈眩了!";
				enemy_turn();
				sanjudge();
				state_load();
			}
			function runaway(){
				if(mb==1)stun();
				else{
					var run=0.5+(state.spd-enemy.spd)*0.1;
					if(run>Math.random()){
						loser=1;
						talk.innerHTML = "成功逃跑了";
						amt();
						sanjudge();
						state_load();
					}
					else{
						talk.innerHTML = "果凍追上來了!";
						enemy_turn();
						sanjudge();
						state_load();
					}
				}
			}
			function go_look(){
				if(mb==1)stun();
				else{
					step++;
					talk.innerHTML = "第"+step+"回合<br>"+"你觀察了"+enemy.name;
					alert("敵人名稱:"+enemy.name+"\n等級"+enemy.lv+"\n攻擊力"+enemy.atk+"\n防禦力"+enemy.def+"\n速度"+enemy.spd);
					enemy_turn();
					sanjudge();
					state_load();
					console.log(enemy);
				}
			}
			function state_load(){
				p1s.innerHTML= "魔法少女 "+player_name+"還剩下"+state.HP+"/"+state.MAXHP+"的生命值跟"+state.SP+"/"+state.MAXSP+"的san值";
				mons.innerHTML=enemy.name+"還有"+enemy.HP+"的生命值";
				mons.innerHTML+="<img class='wooden' src='"+enemy.name+".png'>";
				if(loser==1){
					battle=0;
					bd.style.visibility= "hidden";
				}
				else if(enemy.HP<=0){
					battle=0;
					bd.style.visibility= "hidden";
					kof.style.visibility= "visible";
					if(state.sin<-500){
						forgave.style.visibility = "hidden";
					}
					talk.innerHTML="你戰勝了"+enemy.name+"，現在他任憑你處置，你會......?";
					mb=0;
					amt();
				}
			}
			function kill(){
				sanjudge();
				talk.innerHTML="第"+step+"回合<br>"+enemy.name+"被你打爆了!<br>你獲得了"+enemy.exp+"點經驗值<br>你獲得了3$!";
				money+=3;
				state.exp+=enemy.exp;
				state.sin-=100;
				if(state.lv<enemy.lv){
					state.exp=0;
					state.lv=enemy.lv;
					talk.innerHTML+="<br>魔法少女"+player_name+"吸收了"+enemy.name+"現在升級了!現在等級"+state.lv;
				}
				else if(state.exp>=100&&state.lv<=10){
					state.exp=0;
					state.lv+=1;
					talk.innerHTML+="<br>魔法少女"+player_name+"升級了!現在等級"+state.lv;
				}
				kof.style.visibility= "hidden";
				if(boss_f==1){
					localStorage.setItem("&end",3);
					window.location.href='end.html';
				}
			}
			function forgive(){
				sanjudge();
				talk.innerHTML="第"+step+"回合<br>"+"你戰勝了"+enemy.name+"並且放了他<br>你獲得了3$!";
				money+=3;
				state.sin+=2;
				kof.style.visibility= "hidden";
				if(boss_f==1){
					if(state.sin>10){
						localStorage.setItem("&end",1);
						window.location.href='end.html';
					}
					else{
						localStorage.setItem("&end",2);
						window.location.href='end.html';
					}
				}
			}
			//以上
			function boss_fight(){
				gogo=0;
				talk.innerHTML = "BOSS巨垂-瑞斯出現了!!!";
				boss_f=1;
				amt();
				fight();
			}
			function open(){
				var kr=Math.floor(Math.random()*10);
				if(kr==0){
					var damage=Math.floor(state.MAXHP*0.2);
					talk.innerHTML = "寶箱爆炸了...你受到了"+damage+"點傷害!";
					state.HP-=damage;
					diejudge();
				}
				else if(kr==1){
					var damage=Math.floor(state.MAXSP*0.2);
					talk.innerHTML = "寶箱飛出一堆蟑螂...你受到了"+damage+"點精神傷害!";
					state.SP-=damage
					sanjudge();
				}
				else if(kr==2){
					talk.innerHTML = "這箱子裡啥都沒裝...";
				}
				else if(kr==3){
					talk.innerHTML = "這箱子裡面有好多錢ㄟ~($+150)";
					money+=150;
				}
				else if(kr==4){
					talk.innerHTML = "你在箱子裡找到一個不知道放了多久的飯糰...";
					backpack.riceball++;
					localStorage.setItem("&backpack",JSON.stringify(backpack));
				}
				else if(kr==5){
					talk.innerHTML = "你在箱子裡找到一杯不知道放了多久的紅茶...";
					backpack.redtea++;
					localStorage.setItem("&backpack",JSON.stringify(backpack));
				}
				else if(kr==6){
					talk.innerHTML = "你在箱子裡找到一顆因為放太久已經變成皮蛋的茶葉蛋...";
					backpack.teaegg++;
					localStorage.setItem("&backpack",JSON.stringify(backpack));
				}
				else{
					talk.innerHTML = "你在箱子裡找到一張紙條，上面寫著'裡面的東西已經被太陽拿走了^^'......";
				}
				amt();
				oos.style.visibility="hidden";
			}
			function skip(){
				talk.innerHTML = "你無視了箱子...";
				amt();
				oos.style.visibility="hidden";
			}
			function random_event(){
				gogo=0;
				var r=Math.floor(Math.random()*4);
				if(r==0){
					talk.innerHTML = "遭遇隨堂考!";
					battle=1;
					fight();
				}	
				else if(r==1){
					talk.innerHTML = "撿到50元~";
					money+=50;
				}
				else if(r==2){
					talk.innerHTML = "啥都沒看到";
				}
				else{
					talk.innerHTML = "發現了奇怪的箱子!";
					oos.style.visibility="visible";
				}
				amt();
			}
			function go_step(){
				oos.style.visibility= "hidden";
				kof.style.visibility= "hidden";
				if(gogo==1){
					alert("你也太急了吧?");
				}
				else if(battle==1){
					alert("還敢下來阿冰鳥?");
				}
				else{
					combo=1;
					++p;
					sanjudge();
					document.getElementById("progress").innerHTML=p;
					if(p==21){
						document.getElementById("progress").innerHTML="end";
						talk.innerHTML = "這到底....這到底甚麼閃現.....齁齁齁齁齁齁";
						localStorage.setItem("$",money);
						localStorage.setItem("&Level_1",1);
						amt();
						back.value="光榮撤退";
						quitalt=1;
					}
					else if(p==20){
						talk.innerHTML = "前進中...";
						gogo=1;
						amt();
						setTimeout(boss_fight,1000);
						quitalt=0;
					}
					else if(p<20){
						talk.innerHTML = "前進中...";
						gogo=1;
						amt();
						setTimeout(random_event,1000);
						quitalt=0;
					}
					else{
						talk.innerHTML = "這前面啥都沒有了";
						amt();
						quitalt=1;
					}
				}
			}
			function go_home(){
				talk.innerHTML = "你確定要離開ㄇ?這樣你一毛都拿不到喔(確定請再次點擊撤退紐)";
				amt();
				++quitalt;
				if(quitalt==2){
					localStorage.setItem(player_name,JSON.stringify(state));
					document.location.href="adventure.html";
				}
			}
			function sanjudge(){
				if(state.SP<-50){
					alert("魔法少女"+player_name+"的精神崩潰了!");
					state.HP-=20;
					state.SP-=5;
					state.def=Math.floor(state.def*0.8);
				}
				else if(state.SP<=0){
					var l=Math.random();
					if(l<0.6){
						alert("魔法少女"+player_name+"的狀況看起來不太好，建議快點回家");
						state.HP-=5;
						alert("魔法少女"+player_name+"對自己造成了5點傷害");
					}
				}
				localStorage.setItem(player_name,JSON.stringify(state));
				diejudge();
			}
			function diejudge(){
				if(state.HP<=0){
					alert("魔法少女"+player_name+"死了");
					again = parseInt(window.prompt("是否要吃茶葉蛋復活?(是/否=輸入1/other)"));
					if(again==1&&backpack.teaegg>0){
						alert(player_name+"復活了!但心靈跟肉體受到了重創(HP上限跟SP上限-10%)");
						state.MAXHP=Math.floor(state.MAXHP*0.9);
						state.MAXSP=Math.floor(state.MAXSP*0.9);
						state.HP=1;
						state.SP=1;
						localStorage.setItem(player_name,JSON.stringify(state));
					}
					else{
						alert("由於沒有茶葉蛋，魔法少女"+player_name+"化成了碎片消失在空中...");
						state.live=0;
						localStorage.setItem(player_name,JSON.stringify(state));
						window.location.href="start_page.html";
					}
				}
			}
			function use_t(){
				if(battle==1){
					alert("我不覺得在戰鬥的時候敵人會讓你有機會吃午餐");
				}
				else{
					if(backpack.riceball+backpack.redtea+backpack.teaegg+backpack.beefnoodles==0){
						alert("你翻了一下包包，然後發現你啥都沒帶");
					}
					else{
						u = parseInt(window.prompt( "你要吃啥?\n0.隨便阿\n1.過期飯糰\n2.HP藥劑\n3.鳳凰の卵\n4.涼麵"));
						if(u>4||u<1){
							alert("你好像又不餓了，收起了背包");
						}
						else if(u==1){
							if(backpack.riceball==0){
								alert("你的背包裡好像沒這東西...");
							}
							else{
								backpack.riceball-=1;
								alert("你吃了幾口放了5天的龍蝦沙拉飯糰，感到一陣噁心，但至少填飽了肚子(HP+10,SP-3)");
								state.HP=Math.min(state.HP+10,state.MAXHP);
								state.SP-=3;
							}
						}
						else if(u==2){
							if(backpack.redtea==0){
								alert("你的背包裡好像沒這東西...");
							}
							else{
								backpack.redtea-=1;
								alert("你喝了一口HP藥劑，SP回復了(SP+5)");
								state.SP=Math.min(state.SP+5,state.MAXSP);
							}
						}
						else if(u==3){
							if(backpack.teaegg==0){
								alert("你的背包裡好像沒這東西...");
							}
							else{
								backpack.teaegg-=1;
								alert("你吃的很飽，但你的口很渴");
							}
						}
						else if(u==4){
							if(backpack.beefnoodles==0){
								alert("你的背包裡好像沒這東西...");
							}
							else{
								backpack.beefnoodles-=1;
								alert("你吃了這碗放了好久的牛肉麵，吃完一肚子火(HP+50,SP+10,ATK+1)");
								state.HP=Math.min(state.SP+10,state.MAXSP);
								state.SP=Math.min(state.HP+50,state.MAXSP);
								state.ATK++;
							}
						}
						sanjudge();
						localStorage.setItem("&backpack",JSON.stringify(backpack));
					}
				}
				quitalt=0;
			}
			function start(){
				oos.style.visibility="hidden";
				kof.style.visibility="hidden";
				document.getElementById("open").addEventListener("click",open,false);
				document.getElementById("skip").addEventListener("click",skip,false);
				document.getElementById("kill").addEventListener("click",kill,false);
				document.getElementById("forgive").addEventListener("click",forgive,false);
				document.getElementById("take_look").addEventListener("click",go_look,false);
				document.getElementById("attack").addEventListener("click",go_atk,false);
				document.getElementById("skill").addEventListener("click",go_skill,false);
				document.getElementById("run_out").addEventListener("click",runaway,false);
				bd.style.visibility= "hidden";
				money=localStorage.getItem("$");
				money=parseInt(money);
				document.getElementById("go").addEventListener("click",go_step,false);
				document.getElementById("back").addEventListener("click",go_home,false);
				document.getElementById("tool").addEventListener("click",use_t,false);
				amt();
			}
			window.addEventListener("load",start,false);
		</script>
	</body>
</html>
